<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riscatta Gift Card | Mimmo Fratelli</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçé</text></svg>">
    <meta name="theme-color" content="#f8fdf5">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="redeem-page-body">
    <nav style="color: var(--text-color); background: rgba(248, 253, 245, 0.95); backdrop-filter: blur(10px); position: fixed; z-index: 1000;">
        <div class="logo"><a href="index.html">Mimmo Fratelli</a></div>
        <div class="nav-actions">
            <button class="nav-icon-btn" id="authBtn" title="Account">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
            </button>
            <button class="nav-icon-btn" id="cartBtn" title="Carrello">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                </svg>
                <span class="badge" id="cartBadge" style="display:none;">0</span>
            </button>
        </div>
    </nav>

    <main class="redeem-main">
        <div class="redeem-wrapper">
            <!-- Loading State -->
            <div id="loadingState" class="redeem-loading">
                <div class="loading-spinner"></div>
                <p>Caricamento gift card...</p>
            </div>

            <!-- Main Content -->
            <div id="redeemContent" class="redeem-content" style="display: none;">
                <!-- Header -->
                <div class="redeem-header">
                    <div class="redeem-icon">üéÅ</div>
                    <h1 class="redeem-title">Riscatta la tua Gift Card</h1>
                    <p class="redeem-subtitle" id="redeemSubtitle">Aggiungi il credito al tuo account Mimmo Fratelli</p>
                </div>

                <!-- Gift Card Preview (when token detected) -->
                <div id="giftcardPreview" class="giftcard-preview-section" style="display: none;">
                    <div class="giftcard-3d-wrapper">
                        <div class="giftcard-card" id="giftcardCard">
                            <div class="giftcard-front">
                                <div class="giftcard-pattern"></div>
                                <div class="giftcard-header">
                                    <span class="giftcard-logo">Mimmo Fratelli</span>
                                    <span class="giftcard-badge">GIFT CARD</span>
                                </div>
                                <div class="giftcard-amount" id="gcAmount">‚Ç¨0</div>
                                <div class="giftcard-details">
                                    <div class="giftcard-recipient">
                                        <span class="gc-label">Per</span>
                                        <span class="gc-value" id="gcRecipient">---</span>
                                    </div>
                                    <div class="giftcard-from">
                                        <span class="gc-label">Da</span>
                                        <span class="gc-value" id="gcSender">---</span>
                                    </div>
                                </div>
                                <div class="giftcard-message" id="gcMessage" style="display: none;"></div>
                                <div class="giftcard-code" id="gcCode">XXXX-XXXX-XXXX</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auth Required Section -->
                <div id="authRequired" class="auth-required-section" style="display: none;">
                    <div class="auth-icon">üîê</div>
                    <h2 class="auth-title">Accedi per riscattare</h2>
                    <p class="auth-desc">Per aggiungere il credito della gift card al tuo account, devi prima accedere o creare un account.</p>
                    <div class="auth-buttons">
                        <button class="btn-auth-primary" id="loginBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/>
                            </svg>
                            Accedi
                        </button>
                        <button class="btn-auth-secondary" id="registerBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
                            </svg>
                            Crea Account
                        </button>
                    </div>
                    <p class="auth-note">Il credito verr√† aggiunto automaticamente dopo l'accesso</p>
                </div>

                <!-- Manual Code Input (when no token) -->
                <div id="manualInput" class="manual-input-section">
                    <div class="input-wrapper">
                        <label for="redeemCode" class="input-label">Codice Gift Card</label>
                        <input type="text" id="redeemCode" class="redeem-input" placeholder="Es: ABCD1234EFGH56" maxlength="20" autocomplete="off" spellcheck="false">
                        <p class="input-hint">Inserisci il codice di 14 caratteri che trovi sulla gift card o nell'email</p>
                    </div>
                </div>

                <!-- Redeem Button -->
                <div id="redeemActions" class="redeem-actions">
                    <button id="redeemBtn" class="btn-redeem">
                        <span class="btn-text">Riscatta Gift Card</span>
                        <span class="btn-loading" style="display: none;">
                            <span class="spinner-small"></span> Riscatto in corso...
                        </span>
                    </button>
                </div>

                <!-- Message Area -->
                <div id="redeemMessage" class="redeem-message"></div>

                <!-- Success State -->
                <div id="successState" class="success-section" style="display: none;">
                    <div class="success-icon">‚úÖ</div>
                    <h2 class="success-title">Gift Card Riscattata!</h2>
                    <p class="success-amount">‚Ç¨<span id="creditedAmount">0</span> aggiunti al tuo credito</p>
                    <p class="success-balance">Nuovo saldo: ‚Ç¨<span id="newBalance">0</span></p>
                    <a href="collection.html" class="btn-shop">Inizia a fare acquisti</a>
                </div>

                <!-- Help Section -->
                <div id="helpSection" class="help-section">
                    <details class="help-accordion">
                        <summary>üí° Dove trovo il codice?</summary>
                        <p>Il codice della gift card √® composto da 14 caratteri alfanumerici. Lo trovi:</p>
                        <ul>
                            <li>Nell'email che hai ricevuto con la gift card</li>
                            <li>Sulla gift card digitale (sotto il QR code)</li>
                            <li>Nel Google/Apple Wallet se l'hai salvata</li>
                        </ul>
                    </details>
                    <details class="help-accordion">
                        <summary>‚ùì Come funziona il credito?</summary>
                        <p>Il credito della gift card viene aggiunto al tuo account e puoi usarlo per pagare i tuoi ordini. Il credito non scade e puoi usarlo in pi√π acquisti.</p>
                    </details>
                </div>
            </div>
        </div>
    </main>

    <style>
        /* Base Layout */
        .redeem-page-body { background: linear-gradient(135deg, #f8fdf5 0%, #e8f5e0 50%, #f0f9eb 100%); min-height: 100vh; }
        .redeem-main { padding: 100px 1rem 2rem; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .redeem-wrapper { width: 100%; max-width: 480px; margin: 0 auto; }
        
        /* Loading */
        .redeem-loading { text-align: center; padding: 3rem; }
        .loading-spinner { width: 48px; height: 48px; border: 4px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Content Card */
        .redeem-content { background: white; border-radius: 24px; padding: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.08); }
        
        /* Header */
        .redeem-header { text-align: center; margin-bottom: 1.5rem; }
        .redeem-icon { font-size: 3rem; margin-bottom: 0.5rem; animation: bounce 2s ease infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .redeem-title { font-family: var(--font-display); font-size: 1.75rem; font-style: italic; color: var(--primary-dark); margin: 0 0 0.5rem; }
        .redeem-subtitle { color: #666; font-size: 0.95rem; margin: 0; }
        
        /* Gift Card 3D Preview */
        .giftcard-preview-section { margin-bottom: 1.5rem; perspective: 1000px; }
        .giftcard-3d-wrapper { display: flex; justify-content: center; }
        .giftcard-card { width: 100%; max-width: 340px; aspect-ratio: 1.6/1; position: relative; transform-style: preserve-3d; animation: cardFloat 4s ease-in-out infinite; }
        @keyframes cardFloat { 0%, 100% { transform: rotateY(-5deg) rotateX(2deg); } 50% { transform: rotateY(5deg) rotateX(-2deg); } }
        .giftcard-front { width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%); border-radius: 16px; padding: 1.25rem; color: white; position: relative; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .giftcard-pattern { position: absolute; top: -50%; right: -30%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%); pointer-events: none; }
        .giftcard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: auto; }
        .giftcard-logo { font-family: var(--font-display); font-style: italic; font-size: 0.9rem; }
        .giftcard-badge { font-size: 0.6rem; padding: 0.2rem 0.5rem; background: rgba(255,255,255,0.15); border-radius: 4px; letter-spacing: 1px; }
        .giftcard-amount { font-size: 2.5rem; font-weight: 700; color: #f9ca24; text-align: center; margin: 0.5rem 0; }
        .giftcard-details { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.5rem; }
        .gc-label { opacity: 0.6; display: block; }
        .gc-value { font-weight: 500; }
        .giftcard-message { font-style: italic; font-size: 0.75rem; opacity: 0.7; text-align: center; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 0.5rem; }
        .giftcard-code { font-family: 'SF Mono', monospace; font-size: 0.85rem; text-align: center; letter-spacing: 2px; opacity: 0.8; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); }

        /* Auth Required */
        .auth-required-section { text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border-radius: 16px; margin-bottom: 1.5rem; border: 1px solid #ffc107; }
        .auth-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .auth-title { font-size: 1.25rem; font-weight: 600; color: #856404; margin: 0 0 0.5rem; }
        .auth-desc { color: #856404; font-size: 0.9rem; margin: 0 0 1.25rem; line-height: 1.5; }
        .auth-buttons { display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap; }
        .btn-auth-primary, .btn-auth-secondary { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.875rem 1.5rem; border-radius: 12px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-auth-primary { background: var(--primary); color: white; }
        .btn-auth-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(61,124,71,0.3); }
        .btn-auth-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-auth-secondary:hover { background: var(--primary-soft); transform: translateY(-2px); }
        .auth-note { font-size: 0.8rem; color: #856404; margin: 1rem 0 0; opacity: 0.8; }
        
        /* Manual Input */
        .manual-input-section { margin-bottom: 1.5rem; }
        .input-wrapper { position: relative; }
        .input-label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; color: #333; }
        .redeem-input { width: 100%; padding: 1rem 1.25rem; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 1.1rem; text-align: center; text-transform: uppercase; letter-spacing: 3px; font-family: 'SF Mono', 'Fira Code', monospace; transition: all 0.2s; background: #fafafa; }
        .redeem-input:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(61,124,71,0.1); }
        .redeem-input::placeholder { text-transform: none; letter-spacing: normal; font-family: var(--font-body); color: #999; }
        .input-hint { font-size: 0.8rem; color: #888; margin: 0.5rem 0 0; text-align: center; }
        
        /* Redeem Button */
        .redeem-actions { margin-bottom: 1rem; }
        #redeemBtn { display: flex !important; align-items: center; justify-content: center; width: 100%; padding: 1rem 1.5rem; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; border-radius: 12px; font-size: 1.05rem; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(61,124,71,0.3); }
        #redeemBtn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(61,124,71,0.4); }
        #redeemBtn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .spinner-small { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; margin-right: 0.5rem; }
        
        /* Messages */
        .redeem-message { padding: 1rem; border-radius: 12px; text-align: center; font-weight: 500; margin-bottom: 1rem; display: none; }
        .redeem-message.success { display: block; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .redeem-message.error { display: block; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .redeem-message.info { display: block; background: #cce5ff; color: #004085; border: 1px solid #b8daff; }

        /* Success State */
        .success-section { text-align: center; padding: 2rem 1rem; }
        .success-icon { font-size: 4rem; margin-bottom: 1rem; animation: successPop 0.5s ease; }
        @keyframes successPop { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .success-title { font-family: var(--font-display); font-size: 1.5rem; font-style: italic; color: var(--primary-dark); margin: 0 0 1rem; }
        .success-amount { font-size: 2rem; font-weight: 700; color: var(--primary); margin: 0 0 0.5rem; }
        .success-balance { color: #666; margin: 0 0 1.5rem; }
        .btn-shop { display: inline-block; padding: 1rem 2rem; background: var(--primary); color: white; text-decoration: none; border-radius: 12px; font-weight: 600; transition: all 0.2s; }
        .btn-shop:hover { background: var(--primary-dark); transform: translateY(-2px); }
        
        /* Help Section */
        .help-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee; }
        .help-accordion { margin-bottom: 0.75rem; }
        .help-accordion summary { cursor: pointer; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; font-weight: 500; font-size: 0.9rem; list-style: none; display: flex; align-items: center; gap: 0.5rem; }
        .help-accordion summary::-webkit-details-marker { display: none; }
        .help-accordion[open] summary { border-radius: 8px 8px 0 0; }
        .help-accordion p, .help-accordion ul { margin: 0; padding: 1rem; background: #fafafa; border-radius: 0 0 8px 8px; font-size: 0.85rem; color: #666; line-height: 1.6; }
        .help-accordion ul { padding-left: 2rem; }
        .help-accordion li { margin-bottom: 0.25rem; }
        
        /* Responsive */
        @media (max-width: 480px) {
            .redeem-main { padding: 80px 0.75rem 1.5rem; align-items: flex-start; }
            .redeem-content { padding: 1.5rem; border-radius: 20px; }
            .redeem-title { font-size: 1.5rem; }
            .redeem-icon { font-size: 2.5rem; }
            .giftcard-card { max-width: 100%; }
            .giftcard-amount { font-size: 2rem; }
            .auth-buttons { flex-direction: column; }
            .btn-auth-primary, .btn-auth-secondary { width: 100%; justify-content: center; }
            .redeem-input { font-size: 1rem; letter-spacing: 2px; padding: 0.875rem 1rem; }
        }
        
        @media (min-width: 768px) {
            .redeem-wrapper { max-width: 520px; }
            .redeem-content { padding: 2.5rem; }
            .giftcard-card:hover { animation-play-state: paused; transform: rotateY(0) rotateX(0) scale(1.02); }
        }
    </style>

    <script src="js/config.js"></script>
    <script type="module">
        import { authService } from './js/services/auth.js';
        import { authModal } from './js/components/auth-modal.js';
        import { cartService } from './js/services/cart.js';
        import { cartDrawer } from './js/components/cart-drawer.js';
        import { profileDrawer } from './js/components/profile-drawer.js';
        import { giftCardService } from './js/services/giftcard.js';
        import { supabase } from './js/supabase.js';

        const PENDING_REDEEM_KEY = 'mimmo_pending_giftcard_redeem';
        let currentGiftCard = null;
        let qrToken = null;
        let isAuthenticated = false;

        // DOM Elements
        const els = {
            loading: document.getElementById('loadingState'),
            content: document.getElementById('redeemContent'),
            preview: document.getElementById('giftcardPreview'),
            authRequired: document.getElementById('authRequired'),
            manualInput: document.getElementById('manualInput'),
            redeemActions: document.getElementById('redeemActions'),
            redeemBtn: document.getElementById('redeemBtn'),
            redeemCode: document.getElementById('redeemCode'),
            message: document.getElementById('redeemMessage'),
            success: document.getElementById('successState'),
            helpSection: document.getElementById('helpSection'),
            subtitle: document.getElementById('redeemSubtitle')
        };

        function showMessage(text, type = 'info') {
            els.message.textContent = text;
            els.message.className = `redeem-message ${type}`;
        }

        function hideMessage() {
            els.message.className = 'redeem-message';
        }

        function setButtonLoading(loading) {
            const btn = els.redeemBtn;
            btn.disabled = loading;
            btn.querySelector('.btn-text').style.display = loading ? 'none' : 'inline';
            btn.querySelector('.btn-loading').style.display = loading ? 'inline-flex' : 'none';
        }

        function renderGiftCard(gc) {
            document.getElementById('gcAmount').textContent = `‚Ç¨${parseFloat(gc.balance || gc.amount).toFixed(0)}`;
            document.getElementById('gcRecipient').textContent = gc.recipient_name || 'Te';
            document.getElementById('gcSender').textContent = gc.sender_name || 'Un amico';
            document.getElementById('gcCode').textContent = gc.code || '---';
            
            const msgEl = document.getElementById('gcMessage');
            if (gc.message) {
                msgEl.textContent = `"${gc.message}"`;
                msgEl.style.display = 'block';
            } else {
                msgEl.style.display = 'none';
            }
            
            els.preview.style.display = 'block';
            els.manualInput.style.display = 'none';
            els.subtitle.textContent = `Una gift card da ‚Ç¨${parseFloat(gc.balance || gc.amount).toFixed(0)} ti aspetta!`;
        }

        async function loadGiftCardFromToken(token) {
            const { giftCard, error } = await giftCardService.getGiftCardByToken(token);
            
            if (error || !giftCard) {
                showMessage('Gift card non trovata. Verifica il link o inserisci il codice manualmente.', 'error');
                els.manualInput.style.display = 'block';
                return null;
            }
            
            if (giftCard.is_redeemed) {
                showMessage('Questa gift card √® gi√† stata riscattata.', 'error');
                return null;
            }
            
            if (!giftCard.is_active) {
                showMessage('Questa gift card non √® pi√π attiva.', 'error');
                return null;
            }
            
            currentGiftCard = giftCard;
            renderGiftCard(giftCard);
            return giftCard;
        }

        async function updateAuthState() {
            isAuthenticated = await authService.isAuthenticated();
            
            if (isAuthenticated) {
                els.authRequired.style.display = 'none';
                els.redeemActions.style.display = 'block';
            } else {
                els.authRequired.style.display = 'block';
                els.redeemActions.style.display = 'none';
            }
        }

        function savePendingRedemption() {
            const code = els.redeemCode?.value?.trim();
            const data = qrToken ? { token: qrToken } : { code };
            localStorage.setItem(PENDING_REDEEM_KEY, JSON.stringify(data));
        }

        async function handlePendingRedemption() {
            const pending = localStorage.getItem(PENDING_REDEEM_KEY);
            if (!pending || !isAuthenticated) return;
            
            try {
                const { token, code } = JSON.parse(pending);
                
                if (token && !currentGiftCard) {
                    qrToken = token;
                    await loadGiftCardFromToken(token);
                } else if (code && !currentGiftCard) {
                    els.redeemCode.value = code;
                }
                
                // Auto-redeem with confirmation
                if (currentGiftCard || code) {
                    const amount = currentGiftCard?.balance || currentGiftCard?.amount || '?';
                    if (confirm(`Vuoi riscattare la gift card da ‚Ç¨${amount} ora?`)) {
                        await redeemGiftCard();
                    } else {
                        localStorage.removeItem(PENDING_REDEEM_KEY);
                    }
                }
            } catch (err) {
                console.error('Pending redemption error:', err);
                localStorage.removeItem(PENDING_REDEEM_KEY);
            }
        }

        async function redeemGiftCard() {
            hideMessage();
            setButtonLoading(true);
            
            try {
                let tokenToRedeem = qrToken;
                
                // If no token, validate code first
                if (!tokenToRedeem) {
                    const code = els.redeemCode.value.trim().toUpperCase();
                    if (!code || code.length < 10) {
                        showMessage('Inserisci un codice valido (14 caratteri)', 'error');
                        setButtonLoading(false);
                        return;
                    }
                    
                    const { valid, giftCard, error } = await giftCardService.validateCode(code);
                    if (!valid) {
                        showMessage(error || 'Codice non valido', 'error');
                        setButtonLoading(false);
                        return;
                    }
                    
                    tokenToRedeem = giftCard.qr_code_token;
                    currentGiftCard = giftCard;
                    renderGiftCard(giftCard);
                }
                
                // Redeem
                const result = await giftCardService.redeemGiftCard(tokenToRedeem);
                
                if (result.success) {
                    localStorage.removeItem(PENDING_REDEEM_KEY);
                    
                    // Show success
                    document.getElementById('creditedAmount').textContent = result.amount_credited?.toFixed(2) || currentGiftCard?.amount;
                    document.getElementById('newBalance').textContent = result.new_balance?.toFixed(2) || '0.00';
                    
                    els.preview.style.display = 'none';
                    els.manualInput.style.display = 'none';
                    els.redeemActions.style.display = 'none';
                    els.helpSection.style.display = 'none';
                    els.success.style.display = 'block';
                    
                    document.querySelector('.redeem-header').style.display = 'none';
                } else {
                    showMessage(result.error || 'Errore durante il riscatto', 'error');
                }
            } catch (err) {
                console.error('Redeem error:', err);
                showMessage('Errore durante il riscatto. Riprova.', 'error');
            } finally {
                setButtonLoading(false);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await authService.init();
            authModal.init();
            cartDrawer.init();
            profileDrawer.init();

            // Check URL for token
            const urlParams = new URLSearchParams(window.location.search);
            qrToken = urlParams.get('token');
            
            // Load gift card if token present
            if (qrToken) {
                await loadGiftCardFromToken(qrToken);
            }
            
            // Check auth
            await updateAuthState();
            
            // Handle pending redemption after login
            await handlePendingRedemption();
            
            // Show content
            els.loading.style.display = 'none';
            els.content.style.display = 'block';

            // Event Listeners
            document.getElementById('authBtn').addEventListener('click', async () => {
                if (await authService.isAuthenticated()) {
                    profileDrawer.show();
                } else {
                    authModal.show('login');
                }
            });

            document.getElementById('cartBtn').addEventListener('click', () => cartDrawer.show());

            document.getElementById('loginBtn').addEventListener('click', () => {
                savePendingRedemption();
                authModal.show('login');
            });

            document.getElementById('registerBtn').addEventListener('click', () => {
                savePendingRedemption();
                authModal.show('register');
            });

            els.redeemBtn.addEventListener('click', async () => {
                if (!isAuthenticated) {
                    savePendingRedemption();
                    authModal.show('login');
                    return;
                }
                await redeemGiftCard();
            });

            // Format code input
            els.redeemCode.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            });

            // Listen for auth changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    await updateAuthState();
                    await handlePendingRedemption();
                } else if (event === 'SIGNED_OUT') {
                    await updateAuthState();
                }
            });

            // Update cart badge
            const updateCartBadge = async () => {
                const count = await cartService.getCount();
                const badge = document.getElementById('cartBadge');
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'flex' : 'none';
                }
            };
            updateCartBadge();
            cartService.onChange(updateCartBadge);
        });
    </script>
</body>
</html>
